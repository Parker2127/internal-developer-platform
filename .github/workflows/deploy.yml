name: Deploy to AKS

# Portfolio Showcase Project
# This workflow demonstrates IaC and CI/CD best practices
# Deploy job is disabled - requires Azure subscription and credentials
# Validation job runs to verify configuration integrity

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: idp-platform-rg
  CLUSTER_NAME: idp-cluster

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Run validation script
        run: |
          chmod +x scripts/validate.sh
          bash scripts/validate.sh

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: validate
    # Skip actual deployment in portfolio showcase - requires Azure credentials
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.CLUSTER_NAME }} \
            --overwrite-existing
      
      - name: Deploy to Kubernetes
        run: |
          python3 scripts/deploy.py \
            --app sample-app \
            --manifest kubernetes/deployment.yaml \
            --namespace default
      
      - name: Apply Service
        run: |
          kubectl apply -f projects/internal-developer-platform/kubernetes/service.yaml
      
      - name: Get Service Status
        run: |
          kubectl get svc sample-app -n default
          kubectl get pods -l app=sample-app -n default
