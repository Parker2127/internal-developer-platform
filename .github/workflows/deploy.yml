name: Deploy to Kubernetes

# Production-grade CI/CD pipeline with automated deployment to K3s
# Validates infrastructure code and deploys to local Kubernetes cluster

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  CLUSTER_NAME: idp-demo-cluster
  NAMESPACE: default

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Run validation script
        run: |
          chmod +x scripts/validate.sh
          bash scripts/validate.sh

  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up K3s
        run: |
          curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644
          mkdir -p ~/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
          sudo chown $USER ~/.kube/config
          echo "Waiting for K3s to be ready..."
          sleep 15
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
      
      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl get pods -A
      
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f kubernetes/deployment.yaml
          kubectl apply -f kubernetes/service.yaml
      
      - name: Wait for deployment
        run: |
          kubectl wait --for=condition=available --timeout=120s deployment/sample-app
          kubectl get deployments
          kubectl get pods
      
      - name: Run health checks
        run: |
          echo "üè• Running health checks..."
          kubectl get pods -l app=sample-app -o wide
          
          # Check pod status
          POD_STATUS=$(kubectl get pods -l app=sample-app -o jsonpath='{.items[0].status.phase}')
          if [ "$POD_STATUS" != "Running" ]; then
            echo "‚ùå Pod not running. Status: $POD_STATUS"
            kubectl describe pods -l app=sample-app
            exit 1
          fi
          
          # Check readiness
          READY=$(kubectl get pods -l app=sample-app -o jsonpath='{.items[0].status.conditions[?(@.type=="Ready")].status}')
          if [ "$READY" != "True" ]; then
            echo "‚ùå Pod not ready"
            kubectl describe pods -l app=sample-app
            exit 1
          fi
          
          echo "‚úÖ All health checks passed!"
      
      - name: Get service status
        run: |
          kubectl get svc sample-app
          kubectl describe svc sample-app
      
      - name: Deployment summary
        if: always()
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          kubectl get all -l app=sample-app
          echo ""
          echo "üìã Recent events:"
          kubectl get events --sort-by='.lastTimestamp' | tail -20
          kubectl get pods -l app=sample-app -n default
